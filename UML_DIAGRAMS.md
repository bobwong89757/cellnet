# Cellnet UML 架构图

本文档使用 UML 图描述 Cellnet 项目的类继承/组合关系和消息处理流程。

## 1. 核心接口继承关系图

### 1.1 Peer 接口层次结构

```
┌─────────────────────────────────────────────────────────────┐
│                        <<interface>>                        │
│                          Peer                               │
│  + Start() Peer                                             │
│  + Stop()                                                   │
│  + TypeName() string                                        │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ implements
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│ <<interface>>  │                    │  <<interface>>  │
│ PeerProperty   │                    │  GenericPeer    │
│ + Name()       │                    │  (组合接口)      │
│ + Address()    │                    └─────────────────┘
│ + Queue()      │
│ + SetName()    │
│ + SetAddress() │
│ + SetQueue()   │
└────────────────┘
        ▲
        │ implements
        │
┌───────┴──────────────────────────────────────────────────────┐
│                    CorePeerProperty                          │
│              (结构体实现，嵌入到具体 Peer)                    │
└──────────────────────────────────────────────────────────────┘
```

### 1.2 Session 接口层次结构

```
┌─────────────────────────────────────────────────────────────┐
│                        <<interface>>                        │
│                         Session                             │
│  + Raw() interface{}                                        │
│  + Peer() Peer                                              │
│  + Send(msg interface{})                                    │
│  + Close()                                                  │
│  + ID() int64                                               │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ implements
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│  tcpSession    │                    │  KcpSession     │
│  (TCP实现)     │                    │  (KCP实现)      │
└────────────────┘                    └─────────────────┘
        │                                       │
        │ embeds                                │ embeds
        ▼                                       ▼
┌──────────────────┐                  ┌──────────────────┐
│ CoreProcBundle   │                  │ CoreProcBundle   │
│ CoreContextSet   │                  │ CoreContextSet   │
│ CoreSessionIdentify│                │ CoreSessionIdentify│
└──────────────────┘                  └──────────────────┘
```

### 1.3 Codec 接口层次结构

```
┌─────────────────────────────────────────────────────────────┐
│                        <<interface>>                        │
│                          Codec                              │
│  + Encode(msgObj, ctx) (data, err)                         │
│  + Decode(data, msgObj) error                              │
│  + Name() string                                            │
│  + MimeType() string                                        │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ implements
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│  binaryCodec   │                    │   jsonCodec     │
│  (二进制)      │                    │   (JSON)        │
└────────────────┘                    └─────────────────┘
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│  gogopbCodec   │                    │  httpjsonCodec  │
│  (Gogo PB)     │                    │  (HTTP JSON)    │
└────────────────┘                    └─────────────────┘
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│  protoplus     │                    │  httpFormCodec  │
│  (ProtoPlus)   │                    │  (HTTP Form)    │
└────────────────┘                    └─────────────────┘
```

### 1.4 Processor 接口层次结构

```
┌─────────────────────────────────────────────────────────────┐
│                        <<interface>>                        │
│                    MessageTransmitter                       │
│  + OnRecvMessage(ses) (msg, err)                           │
│  + OnSendMessage(ses, msg) error                           │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ implements
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│ TCPMessageTransmitter│              │KCPMessageTransmitter│
│  (TCP实现)     │                    │  (KCP实现)      │
└────────────────┘                    └─────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                        <<interface>>                        │
│                       EventHooker                           │
│  + OnInboundEvent(input) (output)                          │
│  + OnOutboundEvent(input) (output)                         │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ implements
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│   MsgHooker    │                    │  MultiHooker    │
│  (TCP/KCP)     │                    │  (组合钩子)     │
└────────────────┘                    └─────────────────┘
```

### 1.5 Event 接口层次结构

```
┌─────────────────────────────────────────────────────────────┐
│                        <<interface>>                        │
│                          Event                              │
│  + Session() Session                                        │
│  + Message() interface{}                                    │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ implements
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│ RecvMsgEvent   │                    │  SendMsgEvent   │
│  (接收事件)    │                    │  (发送事件)     │
│  + Send()      │                    └─────────────────┘
│  + Reply()     │
└────────────────┘
        │
        │ implements
        ▼
┌──────────────────┐
│  ReplyEvent      │
│  <<interface>>   │
│  + Reply()       │
└──────────────────┘
```

## 2. Peer 实现类的组合关系

### 2.1 TCP Acceptor 组合关系

```
┌─────────────────────────────────────────────────────────────┐
│                      tcpAcceptor                            │
│  - listener: net.Listener                                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ embeds (组合)
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│SessionManager  │                    │CorePeerProperty │
│                │                    │CoreContextSet   │
│                │                    │CoreRunningTag   │
│                │                    │CoreProcBundle   │
│                │                    │CoreTCPSocketOption│
│                │                    │CoreCaptureIOPanic│
└────────────────┘                    └─────────────────┘
```

### 2.2 HTTP Acceptor 组合关系

```
┌─────────────────────────────────────────────────────────────┐
│                      httpAcceptor                           │
│  - sv: *http.Server                                         │
│  - listener: net.Listener                                   │
│  - httpDir: string                                          │
│  - httpRoot: string                                         │
│  - templateDir: string                                      │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ embeds (组合)
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│CorePeerProperty│                    │CoreProcBundle   │
│CoreContextSet  │                    │                 │
└────────────────┘                    └─────────────────┘
```

### 2.3 KCP Acceptor 组合关系

```
┌─────────────────────────────────────────────────────────────┐
│                      kcpAcceptor                            │
│  - conn: *net.UDPConn                                       │
│  - listener: *kcp.Listener                                  │
│  - sesByConnTrack: map[connTrackKey]*KcpSession            │
│  - sesTimeout: time.Duration                                │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ embeds (组合)
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
┌───────┴────────┐                    ┌────────┴────────┐
│SessionManager  │                    │CorePeerProperty │
│CoreRunningTag  │                    │CoreContextSet   │
│CoreProcBundle  │                    │CoreCaptureIOPanic│
└────────────────┘                    └─────────────────┘
```

## 3. 消息处理流程图

### 3.1 消息接收流程 (Inbound)

```
┌─────────────────────────────────────────────────────────────────┐
│                     网络层 (Network Layer)                      │
│                    TCP/UDP/HTTP/WebSocket/KCP                   │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 原始数据
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                  Session.recvLoop()                             │
│                  (接收循环，持续读取网络数据)                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 调用
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│            CoreProcBundle.ReadMessage(ses)                      │
│            (从 Session 读取消息)                                │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 调用
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│        MessageTransmitter.OnRecvMessage(ses)                    │
│        (消息传输器，协议相关实现)                                │
│        - TCPMessageTransmitter                                  │
│        - KCPMessageTransmitter                                  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 解码
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              Codec.Decode(data, msgObj)                         │
│              (消息解码，格式相关)                                │
│              - binaryCodec                                      │
│              - jsonCodec                                        │
│              - gogopbCodec                                      │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 创建事件
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              RecvMsgEvent{Ses: ses, Msg: msg}                   │
│              (创建接收消息事件)                                  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 处理
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│            CoreProcBundle.ProcEvent(ev)                         │
│            (处理事件)                                            │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 钩子处理
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│        EventHooker.OnInboundEvent(input)                        │
│        (入站事件钩子，可插入自定义逻辑)                          │
│        - RPC 处理                                               │
│        - Relay 处理                                             │
│        - 消息日志记录                                           │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 回调
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              EventCallback(ev)                                  │
│              (用户定义的事件处理回调)                            │
│              - 业务逻辑处理                                     │
└─────────────────────────────────────────────────────────────────┘
```

### 3.2 消息发送流程 (Outbound)

```
┌─────────────────────────────────────────────────────────────────┐
│              应用层调用 Session.Send(msg)                       │
│              (用户代码发送消息)                                  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 放入队列
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              Session.sendQueue.Add()                            │
│              (发送队列，异步处理)                                │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 发送循环
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              Session.sendLoop()                                 │
│              (发送循环，持续处理队列中的消息)                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 创建事件
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              SendMsgEvent{Ses: ses, Msg: msg}                   │
│              (创建发送消息事件)                                  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 处理
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│            CoreProcBundle.SendMessage(ev)                       │
│            (发送消息)                                            │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 钩子处理
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│        EventHooker.OnOutboundEvent(input)                       │
│        (出站事件钩子，可插入自定义逻辑)                          │
│        - RPC 处理                                               │
│        - Relay 处理                                             │
│        - 消息日志记录                                           │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 编码
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│        MessageTransmitter.OnSendMessage(ses, msg)               │
│        (消息传输器，协议相关实现)                                │
│        - TCPMessageTransmitter                                  │
│        - KCPMessageTransmitter                                  │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 调用
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              Codec.Encode(msgObj, ctx)                          │
│              (消息编码，格式相关)                                │
│              - binaryCodec                                      │
│              - jsonCodec                                        │
│              - gogopbCodec                                      │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 写入网络
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│                     网络层 (Network Layer)                      │
│                    TCP/UDP/HTTP/WebSocket/KCP                   │
└─────────────────────────────────────────────────────────────────┘
```

### 3.3 RPC 消息处理流程

```
┌─────────────────────────────────────────────────────────────────┐
│              客户端调用 RPC.Call(msg, callback)                 │
│              (发起 RPC 请求)                                     │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 创建请求
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              createRequest(msg, callback)                       │
│              - 生成 CallID                                      │
│              - 编码消息                                         │
│              - 创建 RemoteCallREQ                              │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 发送
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              发送流程 (见 3.2 消息发送流程)                      │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 服务端接收
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              接收流程 (见 3.1 消息接收流程)                      │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 钩子处理
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│        EventHooker.OnInboundEvent()                             │
│        └─> rpc.ResolveInboundEvent()                            │
│            - 识别 RemoteCallREQ                                 │
│            - 解码用户消息                                       │
│            - 创建 RecvMsgEvent (包含 CallID)                    │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 用户处理
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              EventCallback(ev)                                  │
│              - 业务逻辑处理                                     │
│              - ev.Reply(responseMsg)                            │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 回复
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              RecvMsgEvent.Reply(msg)                            │
│              - 编码响应消息                                     │
│              - 创建 RemoteCallACK (包含 CallID)                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 发送
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              发送流程 (见 3.2 消息发送流程)                      │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 客户端接收
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              接收流程 (见 3.1 消息接收流程)                      │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 钩子处理
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│        EventHooker.OnInboundEvent()                             │
│        └─> rpc.ResolveInboundEvent()                            │
│            - 识别 RemoteCallACK                                 │
│            - 根据 CallID 查找请求                               │
│            - 解码响应消息                                       │
│            - 触发请求的回调函数                                 │
└─────────────────────────────────────────────────────────────────┘
                            │
                            │ 回调
                            ▼
┌─────────────────────────────────────────────────────────────────┐
│              request.RecvFeedback(responseMsg)                  │
│              - 调用用户回调函数                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 4. 组件交互序列图

### 4.1 消息接收序列图

```
Client          Network        Session        Transmitter      Codec        Hooker        Callback
  │               │              │                │              │            │              │
  │───data───────>│              │                │              │            │              │
  │               │              │                │              │            │              │
  │               │───Read()────>│                │              │            │              │
  │               │              │───OnRecv()────>│              │            │              │
  │               │              │                │───Decode()──>│            │              │
  │               │              │                │<──msg────────│            │              │
  │               │              │<──msg──────────│              │            │              │
  │               │              │                │              │            │              │
  │               │              │───ProcEvent()─>│              │            │              │
  │               │              │                │              │            │              │
  │               │              │                │              │───OnIn()──>│              │
  │               │              │                │              │<──ev───────│              │
  │               │              │                │              │            │              │
  │               │              │                │              │            │───callback()>│
  │               │              │                │              │            │              │
```

### 4.2 消息发送序列图

```
Application     Session        Queue          Hooker        Transmitter    Codec        Network
  │               │              │              │              │              │            │
  │───Send()─────>│              │              │              │              │            │
  │               │───Add()─────>│              │              │              │            │
  │               │              │              │              │              │            │
  │               │<─sendLoop()──│              │              │              │            │
  │               │              │              │              │              │            │
  │               │───SendMsg()─>│              │              │              │            │
  │               │              │              │              │              │            │
  │               │              │───OnOut()───>│              │              │            │
  │               │              │<──ev─────────│              │              │            │
  │               │              │              │              │              │            │
  │               │              │              │───OnSend()──>│              │            │
  │               │              │              │              │───Encode()──>│            │
  │               │              │              │              │<──data───────│            │
  │               │              │              │              │              │            │
  │               │              │              │              │───Write()───>│            │
  │               │              │              │              │              │───data───>│
  │               │              │              │              │              │            │
```

## 5. 核心组件依赖关系

```
┌──────────────┐
│   Peer       │
│  (接口)      │
└──────┬───────┘
       │ uses
       ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│   Session    │─────>│  EventQueue  │<─────│  Processor   │
│  (接口)      │      │  (接口)      │      │  (接口)      │
└──────┬───────┘      └──────────────┘      └──────┬───────┘
       │ uses                                       │ uses
       ▼                                            ▼
┌──────────────┐                           ┌──────────────┐
│    Codec     │                           │    Event     │
│  (接口)      │                           │  (接口)      │
└──────────────┘                           └──────────────┘
       ▲                                            ▲
       │                                            │
┌──────┴───────┐                           ┌───────┴──────┐
│ 各种 Codec   │                           │ 各种 Event   │
│ 实现类       │                           │ 实现类       │
└──────────────┘                           └──────────────┘
```

## 6. 总结

### 6.1 设计模式

1. **接口隔离原则**: 通过多个小接口（Peer、PeerProperty、SessionAccessor 等）组合，而不是一个大接口
2. **组合优于继承**: Go 语言通过嵌入（embedding）实现组合，所有具体实现都组合了核心组件
3. **策略模式**: Codec、MessageTransmitter、EventHooker 都是策略模式的体现
4. **观察者模式**: EventCallback 实现了观察者模式
5. **责任链模式**: EventHooker 链式处理事件

### 6.2 关键特性

1. **协议无关**: 通过接口抽象，支持多种传输协议
2. **编码无关**: 通过 Codec 接口，支持多种编码格式
3. **可扩展**: 所有组件都可以自定义实现
4. **事件驱动**: 基于事件队列的异步处理模型
5. **线程安全**: 通过队列和锁机制保证并发安全

### 6.3 消息处理特点

1. **双向处理**: 接收和发送都有完整的处理流程
2. **钩子机制**: 可以在处理流程中插入自定义逻辑
3. **异步处理**: 通过队列实现异步消息处理
4. **协议透明**: 上层应用不需要关心底层协议细节

